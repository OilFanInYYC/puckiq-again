<!DOCTYPE html>
<html lang="en">

<% title = "PuckIQ | " + team + " | " + season %>
<% include ../_partials/head %>
<% include ../_partials/body-start %>
<% include ../_partials/body-end %>
      <div class="container-fluid" role="main">
        <div class="page-header">
<% renderMenu(team, season) %>
              <div class="row">
                <div class="col-md-12">
                </div>
              </div>
          </div>
        </div>
<% renderTable(players) %>
        <!-- /container -->
    <!-- Core JavaScript
    ================================================== -->
    <script src="http://puckiq.com/js/app.js"></script>
    <script src="http://puckiq.com/js/fixes/ie10-viewport-bug-workaround.js"></script>
    <script type="text/javascript">
// var playerURL = "http://puckiq.com/players";
</script>
<script src="http://puckiq.com/js/tablesort.js"></script>
<script src="http://puckiq.com/js/widgets.js"></script>
<!-- <script src="http://puckiq.com/js/teams.js"></script> -->
<script>
function refreshTableFiltering() {
    var tier = $('#competition').val();
    var positions = $('[name=positions]:checkbox:checked').map(function() { return $(this).val(); }).get()

    $('#puckiq tbody tr').addClass('hidden');
    for (var i = 0; i < positions.length; i++) {
        $('.woodmoney-' + tier + '.pos-' + positions[i]).removeClass('hidden');
    }

    $('#puckiq tbody tr:visible td').css('background', '#efefef');
    $('#puckiq tbody tr:visible:even td').css('background', '#d8f0ff');
}

function updateSeasonOnPageRender() {
    $('#season-input').val('<%= seasonId %>')
    $('#season-input').hide()

    $('#season-title').mouseover(function() {
        $('#season-input').show()
        $('#season-title').hide()
    })

    $('#season-input').mouseout(function() {
        $('#season-input').hide()
        $('#season-title').show()
    })

    $('#season-input').change(function () {
        var newSeason = $('#season-input').val()
        window.location = redirectToSeason(newSeason)
    })
}

function redirectToSeason(seasonId) {
    var url = window.location.href;
    if (url.indexOf('season=') > -1) {
        url = url.replace(/season=\d+/, 'season=' + seasonId)
    } else {
        url += (url.indexOf('season=') = -1) ? '?' : '&'
        url += 'season=' + seasonId
    }
    return url
}

function onPositionsChange() {
    var forwardPosSelected = $('#pos-c:checked, #pos-l:checked, #pos-r:checked').length;
    $('#pos-f').prop('checked', forwardPosSelected == 3);
}

function onForwardChange() {
    var fSelected = $('#pos-f').is(':checked');
    $('#pos-c,#pos-l,#pos-r').prop('checked', fSelected);
}

$(function() {
    $("#puckiq").tablesorter({
        sortInitialOrder  : 'desc',
        widgets           : ['columns'],
    });

    $("[name=positions]").change(onPositionsChange);
    $("#pos-f").change(onForwardChange);

    $("#competition").change(refreshTableFiltering);
    $("[name=positions]").change(refreshTableFiltering);
    $("#pos-f").change(refreshTableFiltering);

    updateSeasonOnPageRender();
    refreshTableFiltering();
})
</script>
<style>
body table {
    font-size: 12px;
    color: black;
}

table {
    margin: 0 0 0 16px;
}

tr.hidden {
    display:none;
}

.page-header {
    margin: 0px;
    border-bottom: none;
}

.page-header h2 {
    margin: 0px;
}

.page-header h4 {
    margin: 0 0 16px 0;
}
<%
function renderMenu(team, season) {
  %>
            <h2><%= team %></h2>
            <h4><div id="season-title"><%= season %></div>
                <select id="season-input" name="season" id="competition" style="display:none">
                  <option value="20172018" selected>2017-18</option>
                  <option value="20162017" selected>2016-17</option>
                  <option value="20152016" selected>2015-16</option>
                  <option value="20142015" selected>2014-15</option>
                </select>
            </h4>
            <div class="row">
                <div class="col-md-4">
                Competition :
                <select name="competition" id="competition">
                  <option value="all" selected>All</option>
                  <option value="elite">Elite</option>
                  <option value="middle">Middle</option>
                  <option value="gritensity">Gritensity</option>
                </select>
                Game Type :
                <select name="gameType" id="gameType">
                  <option value="All">All</option>
                </select>
                <button type="button" class="btn btn-xs btn-success" id="CompSelectSubmit"><strong>Go</strong></button>
                </div>
                <div class="col-md-4 selector">
                  <input type="hidden" id="compSelect" value="All">
                  <input type="hidden" id="confSelect" value="All">
                  Forwards <input type="checkbox" id="pos-f" value="clr" checked="checked" style="margin-right:5px;" />
                  Centres <input type="checkbox" id="pos-c" name="positions" value="c" checked="checked" style="margin-right:5px;" />
                  LW <input type="checkbox" id="pos-l" name="positions" value="l" checked="checked" style="margin-right:5px;" />
                  RW <input type="checkbox" id="pos-r" name="positions" value="r" checked="checked" style="margin-right:5px;" />
                  Defencemen <input type="checkbox" id="pos-d" name="positions" value="d" checked="checked" />
                </div>
            </div>
   <%
}

function renderTable(allPlayersData) {
    %>
                  <table class="table table-bordered table-condensed table-hover" id="puckiq">
                    <thead>
                      <tr>
                        <th>Player</th>
                        <th>Pos</th>
                        <th data-sorter="false">Comp</th>
                        <th data-sorter="false">GT</th>
                        <th>TOI</th>
                        <th>CTOI%</th>
                        <th>CF</th>
                        <th>CA</th>
                        <th>CF%</th>
                        <th>CF/60</th>
                        <th>CA/60</th>
                        <th>CF60RC</th>
                        <th>CA60RC</th>
                        <th>CF%RC</th>
                        <th>CF%RA</th>
                        <th>DFF</th>
                        <th>DFA</th>
                        <th>DFF%</th>
                        <th>DFF/60</th>
                        <th>DFA/60</th>
                        <th>DFF60RC</th>
                        <th>DFA60RC</th>
                        <th>DFF%RC</th>
                        <th>DFF%RA</th>
                        <th>GF</th>
                        <th>GA</th>
                        <th>GF%</th>
                        <th>GF/60</th>
                        <th>GA/60</th>
                      </tr>
                    </thead>
                    <tbody id="dataTable">
     <%
            for (var i = 0; i < allPlayersData.length; i++) {
                renderTableRow(allPlayersData[i])
            }
    %>
                    </tbody>
              </table>
<%
}

function renderTableRow(playerData) {
    var pd = playerData;
    console.log('render ', pd)
    var classname = 'pos-' + pd['ppossible'].toLowerCase() + ' woodmoney-' + pd['woodmoneytier'].toLowerCase() + ' hidden';
    %>
                    <tr class="<%= classname %>">
                        <td style="white-space: nowrap;"><a href="/players/<%=pd['pid']%>"><%= pd['pfullname']%></a></td>
                        <td><%= pd['ppossible']%></td>
                        <td><%= pd['woodmoneytier']%></td>
                        <td>All</td>
                        <td><%= pd['evtoi']%></td>
                        <td>CTOI%</td>
                        <td><%= formatDecimal( pd['cf'] )%></td>
                        <td><%= formatDecimal( pd['ca'] )%></td>
                        <td><%= formatDecimal( pd['cfpct'] )%></td>
                        <td><%= formatDecimal( pd['cf60'] )%></td>
                        <td><%= formatDecimal( pd['ca60'] )%></td>
                        <td><%= formatDecimal( pd['cf60rc'] )%></td>
                        <td><%= formatDecimal( pd['ca60rc'] )%></td>
                        <td><%= formatDecimal( pd['cfpctrc'] )%></td>
                        <td><%= formatDecimal( pd['cfpctra'] )%></td>
                        <td><%= formatDecimal( pd['dff'] )%></td>
                        <td><%= formatDecimal( pd['dfa'] )%></td>
                        <td><%= formatDecimal( pd['dffpct'] )%></td>
                        <td><%= formatDecimal( pd['dff60'] )%></td>
                        <td><%= formatDecimal( pd['dfa60'] )%></td>
                        <td><%= formatDecimal( pd['dff60rc'] )%></td>
                        <td><%= formatDecimal( pd['dfa60rc'] )%></td>
                        <td><%= formatDecimal( pd['dffpctrc'] )%></td>
                        <td><%= formatDecimal( pd['dffpctra'] )%></td>
                        <td><%= pd['gf']%></td>
                        <td><%= pd['ga']%></td>
                        <td><%= formatDecimal( pd['gfpct'] )%></td>
                        <td><%= formatDecimal( pd['gf60'] )%></td>
                        <td><%= formatDecimal( pd['ga60'] )%></td>
                      </tr>

    <%
}

function formatDecimal(val) {
    return parseFloat("" + Math.round(val * 100) / 100).toFixed(2);
}
%>
